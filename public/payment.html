<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>پرداخت - همگام پلاستیک</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Google Fonts (Vazirmatn) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      background-color: #0B1120;
      color: #cbd5e1;
    }
    .glass-card {
        background: rgba(30, 41, 59, 0.5);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(51, 65, 85, 0.5);
        border-radius: 1rem;
    }
    .btn-primary {
        background: linear-gradient(to right, #FBBF24, #F59E0B);
        color: #1e2b3b;
        font-weight: 700;
        padding: 0.75rem 2.5rem;
        border-radius: 9999px;
        transition: all 0.3s ease;
    }
    .btn-primary:hover:not(:disabled) {
        transform: scale(1.05);
    }
    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    /* --- Mobile Menu Fixes --- */
    body.menu-open { overflow: hidden; }
    body.menu-open #mobile-menu { opacity: 1; pointer-events: auto; }
    body.menu-open #logo-link, body.menu-open #cart-link, body.menu-open #user-display { opacity: 0; pointer-events: none; }
    #logo-link, #cart-link, #user-display { transition: opacity 0.3s ease-in-out; }
    body.menu-open #mobile-toggle .fa-bars { display: none; }
    body.menu-open #mobile-toggle .fa-times { display: block; }

    /* Custom Stepper Styles */
    .stepper-item.active .stepper-circle {
        background-color: #FBBF24;
        border-color: #FBBF24;
        color: #1e293b;
    }
    .stepper-item.active .stepper-label {
        color: #FBBF24;
        font-weight: 700;
    }
    .stepper-line {
        height: 2px;
        background-color: #334155;
    }
    .stepper-item.completed .stepper-circle {
        background-color: #475569;
        border-color: #475569;
        color: #94a3b8;
    }
    .stepper-item.completed .stepper-label {
        color: #94a3b8;
    }
  </style>
</head>
<body class="bg-slate-900">

  <!-- Header -->
  <header id="main-header" class="sticky top-0 left-0 right-0 z-30 transition-all duration-300 bg-slate-900/80 backdrop-blur-lg shadow-lg py-3">
   <nav class="container mx-auto px-4 sm:px-6 flex justify-between items-center">
    <a href="index.html" id="logo-link" class="w-24 sm:w-28 md:w-32 transition-opacity duration-300">
      <img id="logo-img" src="image/IMG_9482-removebg-preview.png" alt="لوگو شرکت">
    </a>
    <ul class="hidden lg:flex items-center space-x-8 space-x-reverse text-slate-200 font-semibold">
        <li><a href="index.html" class="hover:text-amber-300 transition-colors">خانه</a></li>
        <li><a href="products.html" class="hover:text-amber-300 transition-colors">محصولات</a></li>
        <li><a href="index.html#about" class="hover:text-amber-300 transition-colors">درباره ما</a></li>
        <li><a href="index.html#technology" class="hover:text-amber-300 transition-colors">تکنولوژی</a></li>
        <li><a href="index.html#contact" class="hover:text-amber-300 transition-colors">تماس با ما</a></li>
    </ul>
    <!-- ✅ FIX STARTS HERE -->
    <div class="flex items-center space-x-4 lg:space-x-6 space-x-reverse">
        <a href="cart.html" id="cart-link" class="text-amber-300 text-xl hover:text-amber-300 transition-colors relative">
          <i class="fas fa-shopping-cart"></i>
          <span id="cart-counter" class="absolute -top-2 -right-3 bg-yellow-400 text-slate-900 text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold" style="display: none;">0</span>
        </a>
        <div id="user-display">
            <a href="login.html" id="login-btn" class="btn-primary !py-1.5 !px-4 sm:!py-2 sm:!px-6 text-sm">ورود</a>
        </div>
        <button id="mobile-toggle" class="lg:hidden text-white text-2xl z-50">
          <i class="fas fa-bars block"></i>
          <i class="fas fa-times hidden"></i>
        </button>
    </div>
    <!-- ✅ FIX ENDS HERE -->
  </nav>
</header>
  
  <!-- Mobile Menu -->
   <div id="mobile-menu" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-40 p-8 text-white text-center transition-opacity duration-300 ease-in-out opacity-0">
    <button id="mobile-close" class="absolute top-6 right-6 text-3xl">&times;</button>
    <ul class="flex flex-col space-y-8 mt-24 text-2xl">
        <li><a href="index.html" class="mobile-link">خانه</a></li>
        <li><a href="products.html" class="mobile-link">محصولات</a></li>
        <li><a href="index.html#about" class="mobile-link">درباره ما</a></li>
        <li><a href="index.html#technology" class="mobile-link">تکنولوژی</a></li>
        <li><a href="index.html#contact" class="mobile-link">تماس با ما</a></li>
    </ul>
</div>

  <main>
    <!-- Hero Section -->
    <section class="relative py-24 md:py-32 flex items-center justify-center text-white overflow-hidden bg-slate-800">
        <div class="absolute inset-0 bg-cover bg-center opacity-10" style="background-image: url('https://images.pexels.com/photos/8947623/pexels-photo-8947623.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');"></div>
        <div class="relative z-10 text-center px-6">
            <h1 class="text-4xl md:text-6xl font-black leading-tight mb-4">پرداخت نهایی</h1>
        </div>
    </section>

    <!-- Payment Content -->
    <div class="container mx-auto px-6 py-16">
        
        <!-- Stepper -->
        <div class="max-w-3xl mx-auto mb-16">
            <div class="flex items-center">
                <div class="stepper-item flex-1 text-center completed">
                    <div class="stepper-circle w-10 h-10 mx-auto rounded-full border-2 flex items-center justify-center font-bold text-lg mb-2 transition-all duration-300">
                        <i class="fas fa-check"></i>
                    </div>
                    <p class="stepper-label text-sm transition-all duration-300">سبد خرید</p>
                </div>
                <div class="stepper-line flex-1"></div>
                <div class="stepper-item flex-1 text-center completed">
                    <div class="stepper-circle w-10 h-10 mx-auto rounded-full border-2 flex items-center justify-center font-bold text-lg mb-2 transition-all duration-300">
                         <i class="fas fa-check"></i>
                    </div>
                    <p class="stepper-label text-sm transition-all duration-300">اطلاعات ارسال</p>
                </div>
                <div class="stepper-line flex-1"></div>
                <div class="stepper-item flex-1 text-center active">
                    <div class="stepper-circle w-10 h-10 mx-auto rounded-full border-2 flex items-center justify-center font-bold text-lg mb-2 transition-all duration-300">3</div>
                    <p class="stepper-label text-sm transition-all duration-300">پرداخت</p>
                </div>
            </div>
        </div>

        <div id="payment-content" class="grid lg:grid-cols-3 gap-8 items-start">
            <!-- Payment Method -->
            <div class="lg:col-span-2 glass-card p-8">
                <h3 class="text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-4">انتخاب روش پرداخت</h3>
                <div class="space-y-6">
                    <div class="glass-card p-6 border-2 border-amber-400 rounded-lg flex items-center space-x-4 space-x-reverse cursor-pointer">
                        <div class="w-6 h-6 rounded-full border-2 border-amber-400 flex items-center justify-center">
                            <div class="w-3 h-3 bg-amber-400 rounded-full"></div>
                        </div>
                        <img src="https://placehold.co/100x40/transparent/white?text=ZarinPal" alt="ZarinPal Logo" class="h-10">
                        <div class="flex-grow">
                            <h4 class="font-bold text-white">پرداخت امن با زرین‌پال</h4>
                            <p class="text-sm text-slate-400">پرداخت از طریق تمامی کارت‌های عضو شبکه شتاب</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <aside class="lg:col-span-1 glass-card p-6 lg:sticky lg:top-28">
                <h3 class="text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-4">خلاصه سفارش</h3>
                <div id="summary-items-list" class="space-y-4 mb-4">
                  <!-- Summary items go here -->
                </div>
                <div class="space-y-4 text-slate-300 border-t border-slate-700 pt-4">
                    <div class="flex justify-between"><span>جمع محصولات</span><span id="subtotal">۰ تومان</span></div>
                    <div class="flex justify-between"><span>هزینه ارسال</span><span id="shipping">۰ تومان</span></div>
                    <div class="flex justify-between border-t border-slate-700 pt-4 mt-4 font-bold text-white text-lg"><span>مبلغ نهایی</span><span id="total">۰ تومان</span></div>
                </div>
                <div class="mt-6 flex flex-col space-y-4">
                    <button id="submit-payment-btn" class="btn-primary w-full text-center">
                        <span class="btn-text">پرداخت و تکمیل سفارش</span>
                        <i class="fas fa-spinner fa-spin hidden"></i>
                    </button>
                    <a href="checkout.html" class="text-center text-slate-400 hover:text-white transition-colors text-sm"><i class="fas fa-arrow-right ml-2"></i>بازگشت به اطلاعات ارسال</a>
                </div>
            </aside>
        </div>
        
    </div>
  </main>
  
  <!-- Footer -->
  <footer id="contact" class="bg-slate-900 border-t border-slate-800 text-slate-400">
      <div class="container mx-auto px-6 py-12">
           <!-- Footer content -->
      </div>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE_URL = ''; // Use relative path for production

    // --- Cart Logic (abbreviated) ---
    const cart = {
        get: () => JSON.parse(localStorage.getItem('shoppingCart')) || [],
        clear: () => localStorage.removeItem('shoppingCart'),
        updateCounter() {
            const totalItems = this.get().reduce((sum, item) => sum + item.quantity, 0);
            const counterEl = document.getElementById('cart-counter');
            if(counterEl) {
                counterEl.textContent = totalItems;
                counterEl.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        },
    };
    
    // --- Page Logic ---
    const summaryItemsList = document.getElementById('summary-items-list');
    const subtotalEl = document.getElementById('subtotal');
    const shippingEl = document.getElementById('shipping');
    const totalEl = document.getElementById('total');
    const paymentBtn = document.getElementById('submit-payment-btn');

    function formatPrice(price) {
        return price.toLocaleString('fa-IR') + ' تومان';
    }

    let totalAmount = 0;

    function renderSummary() {
        const cartData = cart.get();
        const shippingInfo = JSON.parse(localStorage.getItem('shippingInfo'));
        
        summaryItemsList.innerHTML = '';
        let subtotal = 0;

        if (cartData.length === 0 || !shippingInfo) {
            window.location.href = 'cart.html';
            return;
        }

        cartData.forEach(item => {
            subtotal += item.price * item.quantity;
        });

        const shippingCost = subtotal > 0 ? 50000 : 0;
        totalAmount = subtotal + shippingCost;
        
        subtotalEl.textContent = formatPrice(subtotal);
        shippingEl.textContent = formatPrice(shippingCost);
        totalEl.textContent = formatPrice(totalAmount);
    }

    // --- Payment Submission ---
    paymentBtn.addEventListener('click', async () => {
        const cartData = cart.get();
        const shippingInfo = JSON.parse(localStorage.getItem('shippingInfo'));

        if (cartData.length === 0 || !shippingInfo) {
            alert('اطلاعات سفارش ناقص است. لطفا به سبد خرید بازگردید.');
            window.location.href = 'cart.html';
            return;
        }

        paymentBtn.disabled = true;
        paymentBtn.querySelector('.btn-text').classList.add('hidden');
        paymentBtn.querySelector('.fa-spinner').classList.remove('hidden');

        try {
            // 1. Create Order
            const orderResponse = await fetch(`${API_BASE_URL}/api/create-order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    shippingInfo,
                    products: cartData,
                    amount: totalAmount
                })
            });

            if (!orderResponse.ok) {
                const errorData = await orderResponse.json();
                throw new Error(errorData.message || 'خطا در ثبت سفارش');
            }

            const orderData = await orderResponse.json();
            const orderId = orderData.order.orderId;

            // 2. Request Payment
            const paymentResponse = await fetch(`${API_BASE_URL}/api/request-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId })
            });

            if (!paymentResponse.ok) {
                 const errorData = await paymentResponse.json();
                throw new Error(errorData.message || 'خطا در اتصال به درگاه پرداخت');
            }
            
            const paymentData = await paymentResponse.json();

            // 3. Redirect to Gateway
            if (paymentData.payment_url) {
                // Clear local storage before redirecting
                cart.clear();
                localStorage.removeItem('shippingInfo');
                window.location.href = paymentData.payment_url;
            } else {
                throw new Error('پاسخ نامعتبر از درگاه پرداخت');
            }

        } catch (error) {
            alert(`خطا: ${error.message}`);
            paymentBtn.disabled = false;
            paymentBtn.querySelector('.btn-text').classList.remove('hidden');
            paymentBtn.querySelector('.fa-spinner').classList.add('hidden');
        }
    });

    // --- Mobile Menu ---
    const mobileToggle = document.getElementById('mobile-toggle');
    const mobileClose = document.getElementById('mobile-close');
    const mobileLinks = document.querySelectorAll('.mobile-link');

    function toggleMenu() { document.body.classList.toggle('menu-open'); }
    mobileToggle.addEventListener('click', toggleMenu);
    mobileClose.addEventListener('click', toggleMenu);
    mobileLinks.forEach(link => link.addEventListener('click', toggleMenu));
    
    // --- Initial Load ---
    cart.updateCounter();
    renderSummary();
    const checkLoginStatus = () => { /* ... login check logic ... */ };
    checkLoginStatus();
});
</script>

</body>
</html>
